<html>
  <head>
  <title>CBS JSON Explorer</title>
  </head>
  <body>
    <h1>CBS JSON Explorer</h1>
    <div id="divUpload">
      <p>Please upload your JSON file.</p>
    </div id="divViewer">
      <div id="divUpload">
      <input id="btnUpload" type="file" accept=".json" value="Upload JSON" onchange="uploadJson()"/>
      <p id="pUploadResult"></p>
      <div id="navDiv">
        <h4 id="navView"></h4>
        <input type="button" id="btnPrev" value="previous" hidden/>
      </div>
      <ul id="jsonView"></ul>
    </div>
  </body>
</html>


<script>
const stackView     = [];
const stackKey      = [];
const pUploadResult = document.getElementById("pUploadResult");
const jsonView      = document.getElementById("jsonView");
const btnPrev       = document.getElementById("btnPrev");

// static event listeners
document.getElementById("btnPrev").addEventListener("click", drawViewPrev);

function uploadJson() {
  const [file] = document.getElementById("btnUpload").files;
  const reader = new FileReader();
  reader.addEventListener("load", () => { parseInput(reader); }, false);
  if (file) {
    reader.readAsText(file);
  }
}

function parseInput(reader) {
  clearView();
  try {
    jsonData = JSON.parse(reader.result); 
  } catch (e) {
    pUploadResult.textContent = `Parse FAILED: ${e}`;
    pUploadResult.textContent += "Please upload a valid JSON file.";
    return;
  }
  pUploadResult.textContent = "Parse SUCCESS";
  drawView(jsonData)
}

function drawView(data) {
  clearView();
  if (data === null) {
    jsonView.innerHTML = "Object is empty.";
    return;
  }
  keys = Object.keys(data);
  for (let i=0; i<keys.length; i++) {
    const val = data[keys[i]];
    const li = document.createElement("li");
    li.setAttribute("id", keys[i]);
    if (Array.isArray(val)) {
      // is array
      li.innerHTML = `${keys[i]}`;
      const ulArr = document.createElement("ul");
      for (let val_idx in val) {
        const x = val[val_idx];
        // what if each element is also an object?
        const liArr = document.createElement("li");
        if ((!Array.isArray(x)) && typeof(x) === "object") {
          const href = document.createElement("a");
          href.setAttribute("href", "#");
          viewName = `${keys[i]} ${val_idx}`;
          href.innerHTML = viewName;
          liArr.appendChild(href);
          liArr.addEventListener("click", drawViewNext.bind(this, data, data[keys[i]][val_idx], viewName));
        } else {
          liArr.innerHTML = x;
        }
        ulArr.appendChild(liArr);
        li.appendChild(ulArr);
      }
    } else if (typeof(val) === "object" && val !== null) {
      // another json object
      const href = document.createElement("a");
      href.setAttribute("href", "#");
      href.innerHTML = keys[i];
      li.appendChild(href);
      li.addEventListener("click", drawViewNext.bind(this, data, data[keys[i]], keys[i]));
    } else {
      // is regular value
      li.innerHTML = `${keys[i]}: ${val}`;
    }
    jsonView.appendChild(li);
  }

  if (stackView.length === 0) {
    btnPrev.hidden = true;
    navView.innerHTML = "";
  } else {
    btnPrev.hidden = false;
    navView.innerHTML = stackKey.join(" > ");
  }
}

function drawViewNext(data, dataNext, keyView) {
  stackView.push(data);
  stackKey.push(keyView);
  drawView(dataNext);
}

function drawViewPrev() {
  const dataPrev = stackView.pop();
  stackKey.pop()
  drawView(dataPrev);
}

function clearView() {
  jsonView.innerHTML = "";
}

</script>
